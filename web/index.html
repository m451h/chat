<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EHR Chatbot Demo Frontend</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', 'Noto Sans', Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
      height: 100vh;
      display: grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: auto 1fr auto;
      grid-template-areas:
        "sidebar header"
        "sidebar main"
        "sidebar footer";
    }
    header {
      grid-area: header;
      border-bottom: 1px solid #eee;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #sidebar {
      grid-area: sidebar;
      border-right: 1px solid #eee;
      padding: 12px;
      overflow-y: auto;
    }
    main {
      grid-area: main;
      display: grid;
      grid-template-rows: 1fr auto;
      height: 100%;
    }
    #chat {
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    #composer {
      border-top: 1px solid #eee;
      display: flex;
      gap: 8px;
      padding: 12px;
    }
    .msg {
      padding: 10px 12px;
      border-radius: 10px;
      margin: 8px 0;
      max-width: 80%;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg.user {
      background: #e0f2fe;
      align-self: flex-end;
      margin-left: auto;
    }
    .msg.assistant {
      background: #f1f5f9;
      align-self: flex-start;
      margin-right: auto;
    }
    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    input, textarea, button, select {
      font: inherit;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      padding: 8px 12px;
      border: 1px solid #4f46e5;
      background: #4f46e5;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button.secondary {
      background: #fff;
      color: #4f46e5;
    }
    footer {
      grid-area: footer;
      border-top: 1px solid #eee;
      padding: 8px 16px;
      color: #666;
      font-size: 12px;
    }
    .muted {
      color: #666;
      font-size: 12px;
    }
    .small {
      font-size: 12px;
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .error {
      background: #fee;
      color: #c33;
      padding: 8px;
      border-radius: 6px;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <aside id="sidebar">
    <h3>Configuration</h3>
    <div class="row">
      <input id="sessionId" type="text" placeholder="Session ID" value="1" />
    </div>
    <div class="row">
      <input id="apiBase" type="text" placeholder="API Base URL" value="http://localhost:8000" />
    </div>
    <hr />
    <h4>Start New Chat</h4>
    <div class="row">
      <input id="treatmentPlanName" type="text" placeholder="Treatment plan name" value="دیابت نوع دو" />
    </div>
    <div class="row">
      <textarea id="patientJson" rows="8" placeholder="Patient JSON (condition_data)">{ 
  "glucose": [120, 140, 135],
  "hba1c": 7.2,
  "medications": ["Metformin 500mg BID"],
  "diet": { "carbs_per_meal_g": 45 }
}</textarea>
    </div>
    <div class="row">
      <button id="startBtn">Generate Initial Message</button>
    </div>
    <p class="muted">Enter treatment plan name and patient data (JSON). This will generate the initial educational message.</p>
    <hr />
    <div class="row">
      <button id="clearBtn" class="secondary">Clear Chat</button>
    </div>
  </aside>
  <header>
    <strong>EHR Chatbot Demo</strong>
    <span class="muted">API: <code id="apiBaseLabel">http://localhost:8000</code></span>
  </header>
  <main>
    <section id="chat"></section>
    <section id="composer">
      <input id="messageInput" type="text" placeholder="Type your message…" disabled />
      <button id="sendBtn" disabled>Send</button>
    </section>
  </main>
  <footer>
    Simple demo client. Open the API docs at <a href="http://localhost:8000/docs" target="_blank" rel="noreferrer">Swagger UI</a>.
  </footer>

  <script>
    let API_BASE = 'http://localhost:8000';
    let currentSessionId = 1;
    let conversationHistory = [];
    let conditionData = null;

    const $chat = document.getElementById('chat');
    const $sessionId = document.getElementById('sessionId');
    const $apiBase = document.getElementById('apiBase');
    const $treatmentPlanName = document.getElementById('treatmentPlanName');
    const $patientJson = document.getElementById('patientJson');
    const $messageInput = document.getElementById('messageInput');
    const $startBtn = document.getElementById('startBtn');
    const $sendBtn = document.getElementById('sendBtn');
    const $clearBtn = document.getElementById('clearBtn');
    const $apiBaseLabel = document.getElementById('apiBaseLabel');

    function updateApiBase() {
      API_BASE = $apiBase.value.trim() || 'http://localhost:8000';
      $apiBaseLabel.textContent = API_BASE;
    }

    $apiBase.addEventListener('change', updateApiBase);
    $apiBase.addEventListener('blur', updateApiBase);
    updateApiBase();

    function el(tag, className, text) {
      const e = document.createElement(tag);
      if (className) e.className = className;
      if (text !== undefined) e.textContent = text;
      return e;
    }

    function renderMessage(role, content) {
      const msg = el('div', `msg ${role}`);
      msg.textContent = content;
      $chat.appendChild(msg);
      $chat.scrollTop = $chat.scrollHeight;
    }

    function clearChat() {
      $chat.innerHTML = '';
      conversationHistory = [];
    }

    function setLoading(loading) {
      if (loading) {
        document.body.classList.add('loading');
        $startBtn.disabled = true;
        $sendBtn.disabled = true;
        $messageInput.disabled = true;
      } else {
        document.body.classList.remove('loading');
        $startBtn.disabled = false;
        $sendBtn.disabled = conversationHistory.length === 0;
        $messageInput.disabled = conversationHistory.length === 0;
      }
    }

    function showError(message) {
      const errorDiv = el('div', 'error', `Error: ${message}`);
      $chat.appendChild(errorDiv);
      $chat.scrollTop = $chat.scrollHeight;
    }

    async function generateInitialMessage() {
      const treatmentPlanName = $treatmentPlanName.value.trim();
      if (!treatmentPlanName) {
        alert('Please enter a treatment plan name');
        return;
      }

      let patientData = {};
      const jsonText = $patientJson.value.trim();
      if (jsonText) {
        try {
          patientData = JSON.parse(jsonText);
        } catch (e) {
          alert('Invalid JSON in patient data field. Using empty object.');
          patientData = {};
        }
      }

      setLoading(true);
      clearChat();

      try {
        const requestBody = {
          context: {
            treatment_plan_name: treatmentPlanName,
            condition_data: patientData
          }
        };

        const response = await fetch(`${API_BASE}/generate-initial-message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ detail: response.statusText }));
          throw new Error(errorData.detail || `HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success && data.message) {
          // Store condition data for future chat messages
          conditionData = patientData;
          currentSessionId = parseInt($sessionId.value) || 1;
          
          // Add initial message to conversation history
          conversationHistory.push({
            role: 'assistant',
            content: data.message
          });
          
          renderMessage('assistant', data.message);
        } else {
          throw new Error(data.error || 'Failed to generate initial message');
        }
      } catch (error) {
        console.error('Error generating initial message:', error);
        showError(error.message);
      } finally {
        setLoading(false);
      }
    }

    async function sendMessage() {
      const text = $messageInput.value.trim();
      if (!text) return;

      // Add user message to UI and history
      renderMessage('user', text);
      conversationHistory.push({
        role: 'user',
        content: text
      });
      
      $messageInput.value = '';
      setLoading(true);

      try {
        currentSessionId = parseInt($sessionId.value) || 1;

        const requestBody = {
          question: text,
          session_id: currentSessionId,
          conversation_history: conversationHistory.slice(0, -1), // Exclude the current question
          condition_data: conditionData
        };

        const response = await fetch(`${API_BASE}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ detail: response.statusText }));
          throw new Error(errorData.detail || `HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success && data.answer) {
          // Add assistant response to conversation history
          conversationHistory.push({
            role: 'assistant',
            content: data.answer
          });
          
          renderMessage('assistant', data.answer);
        } else {
          throw new Error(data.error || 'Failed to get response');
        }
      } catch (error) {
        console.error('Error sending message:', error);
        showError(error.message);
        // Remove the user message from history if request failed
        conversationHistory.pop();
      } finally {
        setLoading(false);
      }
    }

    $startBtn.addEventListener('click', generateInitialMessage);
    $sendBtn.addEventListener('click', sendMessage);
    $clearBtn.addEventListener('click', () => {
      clearChat();
      conditionData = null;
      setLoading(false);
    });

    $messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey && !$sendBtn.disabled) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
